@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@Scripts.Render("~/Scripts/Knockout-3.2.0.js")
@Scripts.Render("~/Scripts/guildUtils.js")
@{
    ViewBag.Title = "Guild Roster";
}


<script type="text/javascript">
    $.ajax({
        type: "GET",
        url: 'http://us.battle.net/api/wow/guild/Blackrock/Pokemon%20Masters?fields=members&jsonp=bindMembers',
        dataType: "JSONP"
    });

    function bindMembers(data) {
        var mappedMembers = $.map(data.members, function (member) {
            return {
                Name: member.character.name,
                Rank: member.rank,
                memberUrl: "/Static/ViewPlayer.html?name=" + member.character.name
            };
        }).sort(function (a, b) {
            return a.Rank - b.Rank;
        });

        ko.applyBindings({
            guildMembers: mappedMembers
        });
    }

    $('body').on('hidden.bs.modal', '.modal', function () {
        $(this).removeData('bs.modal');
    });
</script>

<table class="table table-hover">
    <thead>
        <tr>
            <th>Character Name</th>
            <th>Rank</th>
        </tr>
    </thead>
    <tbody data-bind="foreach: guildMembers">
        <tr>
            <td><a id="aPlayer" data-toggle="modal" data-target="#myModal"
                   data-bind="click: Name, text: Name"></a></td>
            <td data-bind="text: getRankName(Rank)"></td>
        </tr>
    </tbody>
</table>

<div id="myModal" class="modal hide fade">
    <script type="text/javascript">
        $.ajax({
            type: "GET",
            url: 'http://us.battle.net/api/wow/character/Blackrock/' + GetQueryStringParams("name") + '?fields=items,professions,progression,stats,talents&jsonp=getPlayer',
            dataType: "JSONP"
        });

        function getPlayer(player) {
            console.log(player);
            ko.applyBindings({
                Name: player.name,
                Pic: "http://us.battle.net/static-render/us/" + player.thumbnail,
                Class: player.class,
                Race: player.race,
                Stats: player.stats,
                Talents: player.talents,
                Progression: player.progression.raids[31].bosses,
                Level: player.level,
                ilvl: player.items.averageItemLevel,
                Achives: player.achievementPoints
            });
        }
    </script>
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"> × </button>
        <h3 id="myModalLabel">Modal header</h3>
    </div>
    <div class="modal-body">
        <img data-bind="attr: {src: Pic, alt: Name}" />
        <img data-bind="attr: {src: getClassIcon(Class), alt: getClass(Class)}" />
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    </div>
</div>